---
title: "Main models: Visual sensitivity in the far-red enhances contrast against vegetation"
author: <br>Lu-Yi Wang^1^, Devi Stuart-Fox^1^, Geoff Walker^1^, Nicholas W. Roberts^2^
  and Amanda M. Franklin^1^ <br></br> ^1^School of Biosciences, The University of Melbourne,
  Australia <br></br> ^2^School of Biological Sciences, University of Bristol, UK
  <br></br>
output:
  html_document:
    theme: flatly
    toc: true
    toc_depth: 2
  pdf_document: default
subtitle: Supplementary Information
Date: August 31 2021
---

# The aims
  
* We used visual modelling to investigate the potential benefit of long wavelength sensitivity for insects.

* Specifically, we varied the presence of a long wavelength sensitive photoreceptor and its peak sensitivity.

* Our study focused on jewel beetles and their host plants because jewel beetles have sensitivity in the far red. 

* Additionally, we tested the effect of red-shifted light environment on contrast by running the same models under twilight illumination.

</br>
</br>

# Load R libraries 
```{r, warning=FALSE, message=FALSE, results='hide'}
library(pavo)
library(dplyr)
library(stringr)
library(tidyr) #for gather() function
library(ggplot2)
library(lme4)
library(car)
library(multcomp)
library(boot) #for mean() function
library(pander) #for creating tidy tables
library(ggpubr) #for ggarrange() function
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE) # Suppress warnings in the HTML output
knitr::opts_chunk$set(cache=TRUE, warning = F) # set up cacheing to save time when re-building the html document
```


</br>
</br>

# Data description

</br>

## Import and process the data

* The wavelength range for all data used in the models was 300-800 nm.

```{r import data,message=FALSE}
# import sensitivity curves
specsensbuprest.aim1 <- read.csv("data/peak sensitivity_filter shift_aim1.csv",header=TRUE) %>%
  as.rspec()
specsensbuprest.aim2 <- read.csv("data/peak sensitivity_filter shift_aim2.csv",header=TRUE) %>%
  as.rspec()

# import irradiance
irradiance.d65 <- read.csv("data/d65.csv",header=TRUE) %>% 
  as.rspec(lim = c(300,800)) %>%  #set import range
  procspec(opt = c("min", "max")) #standardize the illumination spectrum
irradiance.twilight <- read.csv("data/civil twilight.csv",header=TRUE) %>% 
  as.rspec(lim = c(300,800)) %>% 
  rename( twilight = Irradiance) %>% 
  irrad2flux() #convert the irradiance (μ Watt.cm^{-2}) to photon flux (μ mol.s^{-1}.m^{-2}) to derive correct quantum catch.

#import background - average leaf
aveleaf <- read.csv("data/aveleaf.csv",header=TRUE) %>% 
  as.rspec()

#import and combine beetle, flower, leaf together
raw.dataset <- read.csv("data/refelectance spectra.csv",header=TRUE) %>% 
  as.rspec()
dataset <- aggspec(raw.dataset, by = 3, FUN = mean) %>%  #average three measurements to a representative one
  procspec(opt = "smooth", span = 0.1, fixneg = "zero") #smooth the spectra and lift <0 to 0
```

</br>

## Spectral reflectance of the targets

* Jewel beetles and their host plants (leaves and flowers)
    + Leaves: 
        + sample source: mainly from Melton Gardens and Maranoa Gardens (4 from Meblourne roadsides).
        + colour (to human vision): green
        + total number: 46 (all are from the host plant genus of Australian jewel beetles)

    + Flowers: 
        + sample source: mainly from Melton Gardens and Maranoa Gardens (4 from Meblourne roadsides).
        + colour (to human vision): white (10), pink (11), red (10), yellow (9), orange (3), and purple (4)
        + total number: 47 (from 46 species, the same species for leaf reflectance)

    + Beetles:
        + sample source: Australian jewel beetles from, ANIC (29) and our own collection
        + colour (to human vision): red, pink, yellow/orange, green, blue, velvet, black
        + total number: 37

* We averaged of 3 measurements to generate a representative spectrum for each colour
* The spectral data were smoothed with the span = 0.1, and those < 0 were lifted to 0
```{r, fig.cap="Figure caption: Reflectance spectra of the targets"}
#assign categories to each spectrum
category.list <- c("flower","leaf","beetle")
category <- rep(category.list , 
                c(47*501,46*501,37*501))
wavelength <- rep(dataset[,1])

#transform the data for plotting purpose
dataset.transpose <- gather(dataset[,2:131], 
                            key = "species", 
                            value = "reflectance", 
                            na.rm = FALSE,
                          convert = FALSE, 
                          factor_key = FALSE)
dataset.plot.indivisually <- cbind(dataset.transpose, wavelength,category)

#split data by categories for future use
flower.spec <- dataset.plot.indivisually[1:23547,] # 23547 = 47*501
leaf.spec <- dataset.plot.indivisually[23548:46593,] # 46593 = 47*501 + 46*501
beetle.spec <- dataset.plot.indivisually[46594:65130,] # 65130 = 47*501 + 46*501 + 37*501

#merge the spectra before plot here
dataset.plot.indivisually$category2 <- factor(dataset.plot.indivisually$category,
                                              levels = c("leaf","flower","beetle"))

#plot the spectra of the targets used in this model
ggplot(dataset.plot.indivisually,
       aes(x = wavelength, 
           y = reflectance, 
           colour = category2, 
           group = species))+
  geom_point(size =.05)+
  geom_line(size =.05)+
  theme(legend.position = "none")+
  scale_color_manual( values = c( "forestgreen", "palevioletred1","cornflowerblue"))+
  facet_grid(category2 ~ .)+
  xlab("Wavelength (nm)") + 
  ylab("Reflectance (%)")+
  theme_classic()+
  guides(colour = FALSE) # remove the legend
```


</br>
</br>

## Visual sensitivities and visual systems

* We created nine sensitivity curves peaking at 355, 445, 530, 580, 600, 620, 640, 660 nm and classified them into 4 photoreceptor types based on their peaks: 
    + Ultraviolet sensitive (UVS): 355 nm
    + Short-wavelength sensitive (SWS): 445 nm
    + Medium-wavelength sensitive (MWS): 530 nm
    + Long-wavelength sensitive (LWS): 580, 600, 620, 640, 660 nm

* For the LWS, we applied a cut-off filter on the A1opsin sensitivity template peaking at 570 nm to shift the peak sensitivty to longer wavelengths.

* Based on these sensitivities, we created several different visual systems to test two different questions: 
    + What is the benefit of possessing a long wavelength photoreceptor?
    + Is there an benefit to shifting the peak sensitivity of the long wavelength photoreceptor?
  
***
* For the first question we compared the contrast between 3 trichromatic visual system with varied photoreceptor combination. We also tested whether an extra receptor enhanced chromatic contrast by comparing the trichromatic visual systems with a tetrachromatic visual system.
    + Visual systems used: 
        1. Visual system USM (USM): 355 nm, 445 nm, 530 nm (UVS,SWS,MWS)
        2. Visual system UML (UML): 355 nm, 530 nm, 600 nm (UVS,MWS,LWS)
        3. Visual system USL (USL): 355 nm, 445 nm, 600 nm (UVS,SWS,LWS)
        4. Visual system USML (USML): 355 nm, 445 nm, 530 nm, 600 nm (UVS,SWS,MWS,LWS)

***
* For the second question, we tested how the contrast changed as peak sensitivity increased by systematically increasing the peak sensitivity of the LWS photoreceptor from 580-660 nm.
    + Visual systems used:
        1. Visual system 580 (VS 580): 355 nm, 445 nm, 530 nm, 580 nm
        2. Visual system 600 (VS 600): 355 nm, 445 nm, 530 nm, 600 nm
        3. Visual system 620 (VS 620): 355 nm, 445 nm, 530 nm, 620 nm
        4. Visual system 640 (VS 640): 355 nm, 445 nm, 530 nm, 640 nm
        5. Visual system 660 (VS 660): 355 nm, 445 nm, 530 nm, 660 nm


```{r, fig.cap="Figure caption: Sensitivity curves of the photoreceptors with different peak wavelengths."}
wl <- specsensbuprest.aim2[,1]
peaks <- gather(specsensbuprest.aim2[,2:9], peak, value) %>% 
  cbind(wl)

#order the peaks in the legend
peak.order <- c("UVS.355.A1.", "SWS.445.A1.", "MWS.530.A1.", "LWS.570.A1..filter580.", "LWS.570.A1..filter600.", "LWS.570.A1..filter620.", "LWS.570.A1..filter640.", "LWS.570.A1..filter660.") 

ggplot(peaks,
       aes(x = wl, 
                 y = value, 
                 col = peak))+
  geom_line()+
  guides(color = guide_legend(title = "peak sensitivity"))+
  scale_color_manual(
    values = c("darkorchid4", "dodgerblue3", "olivedrab4", "orange1", "orange3","darkorange3", "orangered1", "red2"),
    labels = c("355 nm", "445 nm","530 nm", "580 nm", "600 nm", "620 nm", "640 nm", "660 nm" ),
    breaks = peak.order)+
  xlab("Wavelength (nm)")+ 
  ylab("Relative spectral sensitivity")+
  theme_classic()
```

</br>
</br>

## Illuminations

* Two light environments: daylight and twilight (to represent red-shifted illumination).
  
    + Daylight: __D65__ (standard daylight) from Commission internationale de l'eclairage CIE
    + Twilight: measured at the Pinnacles Lookout in Alpine National Park, VIC, Australia at 18:15 on September 14th 2019.

```{r, fig.cap="Figure caption: Relative irrdiance of D65 (standard daylight) used for the daylight models"}
ggplot(irradiance.d65, 
       aes(x = wl, y = D65))+
  geom_line()+
  xlab("Wavelength (nm)")+
  scale_y_continuous(name = "Relative irradiance (%)")+
  theme_classic()
```

```{r, fig.cap="Figure caption: Absolute irradiance of the twilight used in the twilight models"}
ggplot(irradiance.twilight, 
       aes(x = wl, y = twilight))+
  geom_line()+
  xlab("Wavelength (nm)")+
  scale_y_continuous(name = "Photon flux (umol.s-1.m-2.nm-1)")+
  theme_classic()
```

</br>
</br>

# Run the visual models

</br>
</br>

## First: Quantum catch calculation

* We used the `vismodel` function in the package pavo to calculate quantum catch.
* For each visual system, quantum catch was calculated based on Fechner's law (the signal of the receptor channel is proportional to the logarithm of the quantum catch).
* The average of all leaf spectra was used as the background adapting light.
* The von Kries chromatic adaptation was applied.

```{r Set up functions for quantum catch calculation, message=FALSE}
## D65
get.d65.vismodel <- function(i){
  
  vs.i <- vismodel(dataset[1:501,], 
                   visual = i, #this need to change according to the visual system
                   bkg = aveleaf$aveleaf, 
                   illum = irradiance.d65[1:501,2], 
                   qcatch = 'fi', 
                   relative = FALSE,
                   vonkries = TRUE)
  return(vs.i)
}



## Twilight
get.twilight.vismodel <- function(i){
  
  vs.i <- vismodel(dataset[1:501,], 
                   visual = i, 
                   bkg = aveleaf$aveleaf, 
                   illum = irradiance.twilight[1:501,2], 
                   qcatch = 'fi', 
                   relative = FALSE, 
                   vonkries = TRUE)
  return(vs.i)
}
```

```{r Quantum catch calculation, message=FALSE}
# set up sensitivity list for Aim 1 and Aim 2
sens.list <- list(USM <- specsensbuprest.aim1[, 1:4],
                  UML <- specsensbuprest.aim1[, c(1,2,4,5)],
                  USL <- specsensbuprest.aim1[, c(1,2,3,5)],
                  USML <- specsensbuprest.aim1[, 1:5],
                  VS580 <- specsensbuprest.aim2[, 1:5],
                  VS600 <- specsensbuprest.aim2[, c(1,2,3,4,6)],
                  VS620 <- specsensbuprest.aim2[, c(1,2,3,4,7)],
                  VS640 <- specsensbuprest.aim2[, c(1,2,3,4,8)],
                  VS660 <- specsensbuprest.aim2[, c(1,2,3,4,9)])

# Quantum catch - D65 - Aim 1 & Aim 2
## set up list for holding output
d65.vismodel.output <- list(USM = NA, UML = NA, USL = NA, USML = NA,
                            VS580 = NA, VS600 = NA, VS620 = NA, VS640 = NA, VS660 = NA)
twilight.vismodel.output <- d65.vismodel.output # replicate a same empty list for twilight

## Run the loop
for (i in 1:length(sens.list)){
  
  vs.result.d65 <- get.d65.vismodel(sens.list[[i]]) # for D65
  d65.vismodel.output[[i]] <- vs.result.d65
  
  vs.result.twilight <- get.twilight.vismodel(sens.list[[i]]) # for twilight
  twilight.vismodel.output[[i]] <- vs.result.twilight

}

## D65 Aim 1 & Aim 2 vismodel output
vsUSM <- d65.vismodel.output$USM
vsUML <- d65.vismodel.output$UML
vsUSL <- d65.vismodel.output$USL
vsUSML <- d65.vismodel.output$USML
buprest580 <- d65.vismodel.output$VS580
buprest600 <- d65.vismodel.output$VS600
buprest620 <- d65.vismodel.output$VS620
buprest640 <- d65.vismodel.output$VS640
buprest660 <- d65.vismodel.output$VS660

## Twilight Aim 1 & Aim 2 vismodel output
vsUSM_twilight <- twilight.vismodel.output$USM
vsUML_twilight <- twilight.vismodel.output$UML
vsUSL_twilight <- twilight.vismodel.output$USL
vsUSML_twilight <- twilight.vismodel.output$USML
buprest580_twilight <- twilight.vismodel.output$VS580
buprest600_twilight <- twilight.vismodel.output$VS600
buprest620_twilight <- twilight.vismodel.output$VS620
buprest640_twilight <- twilight.vismodel.output$VS640
buprest660_twilight <- twilight.vismodel.output$VS660
```


</br>
</br>

## Second: Contrast calculation {.tabset .tabset-fade .tabset-pills}

* To calculate chromatic contrast we used the `coldist` function in pavo.
* We used a neural noise-limited model where the noise is proportional to the Weber fraction and is independent of the intensity of the signal received.
* Photoreceptor density of the tetrachromat was based on the opsin gene expression of Emerald ash borer, _Agrilus planipennis_: 1.14, 1, 1.26, 1.38. For the trichromates, we redistributed the lost cone number proportionally to the remaining three cones. (USM: 1.6027, 1.4059, 1.771; UML: 1.4416, 1.5933, 1.7451; USL:1.5481, 1.3580, 1.8740)


* The Weber fraction for the longest cone in the tetrachromat was 0.1, which was used to calculated the unknown signa;-to-noise ratio. To keep the signa;-to-noise ratio the same bwtween the tetrachromat and the trichromates, we adjusted the weber fractions for the longest cone in trichromats to be 0.0883, 0.0889, 0.0858 for USM, UML, USL. 

* In the models using twilight illuminance, we took the photo shot noise into account.

```{r Contrast calculation, message=FALSE}
# set up common list before running loop for calculating contrast
## receptor density
aim1.recep.density.list <- list(USM <- c(1.6027, 1.4059, 1.7714),
                                UML <- c(1.4416, 1.5933, 1.7451),
                                USL <- c(1.5481, 1.3580, 1.8740),
                                USML <- c(1.14,1,1.26,1.38))

## Weber fraction
aim1.web.list <- c(0.1059, 0.1067, 0.1030, 0.12)
aim1.web.ref <- c(3, 3, 3, 4)

# Contrast calculation- D65 - aim 1
## create model data list
aim1.d65.vismodel.list <- list(vsUSM, vsUML, vsUSL, vsUSML)
## combine list before running the loop
aim1.d65.comb.list <- list(vis.list = aim1.d65.vismodel.list,
                           recp.dens.list = aim1.recep.density.list,
                           web.list = aim1.web.list,
                           web.ref = aim1.web.ref)

# list for holding output
aim1.d65.contrast.output <- list(USM = NA, UML = NA, USL = NA, USML = NA)

for (i in 1:length(aim1.d65.comb.list)) {
 
  coldist.result <- coldist(modeldata = aim1.d65.comb.list$vis.list[[i]], # change input model data
                            noise = "neural",
                            achro = FALSE, 
                            n = aim1.d65.comb.list$recp.dens.list[[i]] , # change receptor density
                            weber = aim1.d65.comb.list$web.list[[i]], # change weber's fraction
                            weber.ref = aim1.d65.comb.list$web.ref[[i]] )
  
  aim1.d65.contrast.output[[i]] <- coldist.result
}

CvsUSM <- aim1.d65.contrast.output$USM
CvsUML <- aim1.d65.contrast.output$UML
CvsUSL <- aim1.d65.contrast.output$USL
CvsUSML <- aim1.d65.contrast.output$USML


#Contrast calculation- D65 - Aim 2
get.aim2.d65.coldist <- function(i){
  
  con <- coldist(modeldata = i, # put output of vismodel()
                   noise="neural", 
                   achro=FALSE, 
                   n = c(1.14,1,1.26,1.38),
                   weber = 0.12,
                   weber.ref = 4)
  
  return(con)
}

aim2.d65.contrast.output <- list(VS580 = NA, VS600 = NA, VS620 = NA, VS640 = NA, VS660 = NA)
aim2.d65.vismodel.list <- list(buprest580, 
                               buprest600, 
                               buprest620, 
                               buprest640, 
                               buprest660)

for (i in 1:length(aim2.d65.vismodel.list)) {
  
  contrast.result.i <- get.aim2.d65.coldist(aim2.d65.vismodel.list[[i]])
  aim2.d65.contrast.output[[i]] <- contrast.result.i
}

Cbuprest580 <- aim2.d65.contrast.output$VS580
Cbuprest600 <- aim2.d65.contrast.output$VS600
Cbuprest620 <- aim2.d65.contrast.output$VS620
Cbuprest640 <- aim2.d65.contrast.output$VS640
Cbuprest660 <- aim2.d65.contrast.output$VS660


#Contrast calculation- twilight - aim 1
aim1.twilight.vismodel.list <- list(vsUSM_twilight, 
                                    vsUML_twilight, 
                                    vsUSL_twilight,
                                    vsUSML_twilight)

# Here have to create one comb.list is because vis.model input is different from D65
aim1.twilight.comb.list <- list(vis.list = aim1.twilight.vismodel.list,
                                recp.dens.list = aim1.recep.density.list,
                                web.list = aim1.web.list,
                                web.ref = aim1.web.ref)

# list for holding output
aim1.twilight.contrast.output <- list(USM = NA, UML = NA, USL = NA, USML = NA)

for (i in 1:length(aim1.twilight.comb.list)) {
 
  coldist.result <- coldist(modeldata = aim1.twilight.comb.list$vis.list[[i]], # change input model data
                            noise = "quantum", 
                            achro = FALSE, 
                            n = aim1.twilight.comb.list$recp.dens.list[[i]] , # change receptor density ratio 
                            weber = aim1.twilight.comb.list$web.list[[i]], # change weber's fraction
                            weber.ref = aim1.twilight.comb.list$web.ref[[i]])
  
  aim1.twilight.contrast.output[[i]] <- coldist.result
}

CvsUSM_twilight <- aim1.twilight.contrast.output$USM
CvsUML_twilight <- aim1.twilight.contrast.output$UML
CvsUSL_twilight <- aim1.twilight.contrast.output$USL
CvsUSML_twilight <- aim1.twilight.contrast.output$USML



#Contrast calculation- twilight - Aim 2
get.aim2.twilight.coldist <- function(i){
  
  con <- coldist(modeldata = i,  
                   noise="quantum", 
                   achro=FALSE, 
                   n = c(1.14,1,1.26,1.38), 
                   weber = 0.12, 
                   weber.ref = 4)
  
  return(con)
}

aim2.twilight.contrast.output <- list(VS580 = NA, VS600 = NA, VS620 = NA, VS640 = NA, VS660 = NA)
aim2.twilight.vismodel.list <- list(buprest580_twilight, 
                                    buprest600_twilight, 
                                    buprest620_twilight, 
                                    buprest640_twilight,
                                    buprest660_twilight)

for (i in 1:length(aim2.twilight.vismodel.list)) {
  
  contrast.result.i <- get.aim2.twilight.coldist(aim2.twilight.vismodel.list[[i]])
  aim2.twilight.contrast.output[[i]] <- contrast.result.i
}

Cbuprest580_twilight <- aim2.twilight.contrast.output$VS580
Cbuprest600_twilight <- aim2.twilight.contrast.output$VS600
Cbuprest620_twilight <- aim2.twilight.contrast.output$VS620
Cbuprest640_twilight <- aim2.twilight.contrast.output$VS640
Cbuprest660_twilight <- aim2.twilight.contrast.output$VS660
```

```{r Combine all contrast value in each comparison group}
# Get a column for visual system names 
## Create list required in the loops
aim2.fl.vissys <- list("VS1.fl", "VS2.fl", "VS3.fl", "VS4.fl", "VS5.fl") 
aim2.bl.vissys <- list("VS1.bl", "VS2.bl", "VS3.bl", "VS4.bl", "VS5.bl")
aim2.bf.vissys <- list("VS1.bf", "VS2.bf", "VS3.bf", "VS4.bf", "VS5.bf") 
aim1.fl.vissys <- aim2.fl.vissys[1:4]
aim1.bl.vissys <- aim2.bl.vissys[1:4]
aim1.bf.vissys <- aim2.bf.vissys[1:4]

## Daylight - aim 1
aim1.vissys_d65 <- list(CvsUSM, CvsUML, CvsUSL, CvsUSML)

### flower vs leaf

allvis.fl_d65.aim1 <- data_frame()
for (i in 1:length(aim1.vissys_d65)) {
  
  temp.i <- aim1.vissys_d65[[i]] %>% 
    filter(str_detect(patch1,"flower")) %>% 
    filter(str_detect(patch2,"leaves"))
  
  temp.i$vissys <- strrep(aim1.fl.vissys[[i]],1)
  
  allvis.fl_d65.aim1 <- temp.i %>% rbind(allvis.fl_d65.aim1)  
}

### beetle vs leaf
allvis.bl_d65.aim1 <- data_frame()
for (i in 1:length(aim1.vissys_d65)) {
  
  temp.i <- aim1.vissys_d65[[i]] %>% 
    filter(str_detect(patch2,"beetle")) %>% 
    # Note: for beelte vs. leaf, have to filter from patch 2 then pactch 1
    filter(str_detect(patch1,"leaves"))
  
  temp.i$vissys <- strrep(aim1.bl.vissys[[i]],1)
  
  allvis.bl_d65.aim1 <- temp.i %>% rbind(allvis.bl_d65.aim1)  
}

### beetle vs flower
allvis.bf_d65.aim1 <- data_frame()
for (i in 1:length(aim1.vissys_d65)) {
  
  temp.i <- aim1.vissys_d65[[i]] %>% 
    filter(str_detect(patch1,"flower")) %>% 
    filter(str_detect(patch2,"beetle"))
  
  temp.i$vissys <- strrep(aim1.bf.vissys[[i]],1)
  
  allvis.bf_d65.aim1 <- temp.i %>% rbind(allvis.bf_d65.aim1)  
}




## Twilight - aim 1
aim1.vissys_twilight <- list(CvsUSM_twilight, CvsUML_twilight, CvsUSL_twilight, CvsUSML_twilight)

### flower vs leaf
allvis.fl_twilight.aim1 <- data_frame()
for (i in 1:length(aim1.vissys_twilight)) {
  
  temp.i <- aim1.vissys_twilight[[i]] %>% 
    filter(str_detect(patch1,"flower")) %>% 
    filter(str_detect(patch2,"leaves"))
  
  temp.i$vissys <- strrep(aim1.fl.vissys[[i]],1)
  
  allvis.fl_twilight.aim1 <- temp.i %>% rbind(allvis.fl_twilight.aim1)  
}

### beetle vs leaf
allvis.bl_twilight.aim1 <- data_frame()
for (i in 1:length(aim1.vissys_twilight)) {
  
  temp.i <- aim1.vissys_twilight[[i]] %>% 
    filter(str_detect(patch2,"beetle")) %>% 
    filter(str_detect(patch1,"leaves"))
  
  temp.i$vissys <- strrep(aim1.bl.vissys[[i]],1)
  
  allvis.bl_twilight.aim1 <- temp.i %>% rbind(allvis.bl_twilight.aim1)  
}

### beetle vs flower
allvis.bf_twilight.aim1 <- data_frame()
for (i in 1:length(aim1.vissys_twilight)) {
  
  temp.i <- aim1.vissys_twilight[[i]] %>% 
    filter(str_detect(patch1,"flower")) %>% 
    filter(str_detect(patch2,"beetle"))
  
  temp.i$vissys <- strrep(aim1.bf.vissys[[i]],1)
  
  allvis.bf_twilight.aim1 <- temp.i %>% rbind(allvis.bf_twilight.aim1)  
}


## Daylight - aim 2
aim2.vissys_d65 <- list(Cbuprest580, Cbuprest600, Cbuprest620, Cbuprest640, Cbuprest660)

### flower vs leaf
allvis.fl_d65.aim2 <- data_frame()
for (i in 1:length(aim2.vissys_d65)) {
  
  temp.i <- aim2.vissys_d65[[i]] %>% 
    filter(str_detect(patch1,"flower")) %>% 
    filter(str_detect(patch2,"leaves"))
  
  temp.i$vissys <- strrep(aim2.fl.vissys[[i]],1)
  
  allvis.fl_d65.aim2 <- temp.i %>% rbind(allvis.fl_d65.aim2)  
}

### beetle vs leaf
allvis.bl_d65.aim2 <- data_frame()
for (i in 1:length(aim2.vissys_d65)) {
  
  temp.i <- aim2.vissys_d65[[i]] %>% 
    filter(str_detect(patch2,"beetle")) %>% 
    filter(str_detect(patch1,"leaves"))
  
  temp.i$vissys <- strrep(aim2.bl.vissys[[i]],1)
  
  allvis.bl_d65.aim2 <- temp.i %>% rbind(allvis.bl_d65.aim2)  
}

### beetle vs flower
allvis.bf_d65.aim2 <- data_frame()
for (i in 1:length(aim2.vissys_d65)) {
  
  temp.i <- aim2.vissys_d65[[i]] %>% 
    filter(str_detect(patch1,"flower")) %>% 
    filter(str_detect(patch2,"beetle"))
  
  temp.i$vissys <- strrep(aim2.bf.vissys[[i]],1)
  
  allvis.bf_d65.aim2 <- temp.i %>% rbind(allvis.bf_d65.aim2)  
}


##Twilight - aim 2
aim2.vissys_twilight <- list(Cbuprest580_twilight, Cbuprest600_twilight, Cbuprest620_twilight, Cbuprest640_twilight, Cbuprest660_twilight)

### flower vs leaf
allvis.fl_twilight.aim2 <- data_frame()
for (i in 1:length(aim2.vissys_twilight)) {
  
  temp.i <- aim2.vissys_twilight[[i]] %>% 
    filter(str_detect(patch1,"flower")) %>% 
    filter(str_detect(patch2,"leaves"))
  
  temp.i$vissys <- strrep(aim2.fl.vissys[[i]],1)
  
  allvis.fl_twilight.aim2 <- temp.i %>% rbind(allvis.fl_twilight.aim2)  
}

### beetle vs leaf
allvis.bl_twilight.aim2 <- data_frame()
for (i in 1:length(aim2.vissys_twilight)) {
  
  temp.i <- aim2.vissys_twilight[[i]] %>% 
    filter(str_detect(patch2,"beetle")) %>% 
    filter(str_detect(patch1,"leaves"))
  
  temp.i$vissys <- strrep(aim2.bl.vissys[[i]],1)
  
  allvis.bl_twilight.aim2 <- temp.i %>% rbind(allvis.bl_twilight.aim2)  
}

### beetle vs flower
allvis.bf_twilight.aim2 <- data_frame()
for (i in 1:length(aim2.vissys_twilight)) {
  
  temp.i <- aim2.vissys_twilight[[i]] %>% 
    filter(str_detect(patch1,"flower")) %>% 
    filter(str_detect(patch2,"beetle"))
  
  temp.i$vissys <- strrep(aim2.bf.vissys[[i]],1)
  
  allvis.bf_twilight.aim2 <- temp.i %>% rbind(allvis.bf_twilight.aim2)  
}
```

### Aim 1 {.tabset .tabset-fade .tabset-pills}
The table shows the mean contrast in each comparison group

#### Daylight
```{r}
# Combine comparison groups together in a table
## create a input list for the loop
allvis.aim1_d65.list <- list(allvis.fl_d65.aim1, allvis.bl_d65.aim1, allvis.bf_d65.aim1)

## create a data frame to hold the loop output
contrast.list_d65.aim1 <- data_frame(system = c("USM", "UML", "USL", "USML"),
                                     flower.vs.leaf = NA, 
                                     beetle.vs.leaf = NA, 
                                     beetle.vs.flower = NA)
## loop
for (i in 1:length(allvis.aim1_d65.list)) {
  
   meantable.i <- aggregate(allvis.aim1_d65.list[[i]][,"dS"], 
                            by = list(allvis.aim1_d65.list[[i]]$vissys), 
                            mean) 
   mean.i <- meantable.i[, 2] 
   contrast.list_d65.aim1[,i+1] <- mean.i # here same at column i+1 because the 1st column is the visual system names
}

## print out the table 
contrast.list_d65.aim1 %>% pander() 
```
#### Twilight
```{r}
allvis.aim1_twilight.list <- list(allvis.fl_twilight.aim1, allvis.bl_twilight.aim1, allvis.bf_twilight.aim1)

## create a data frame to hold the loop output
contrast.list_twilight.aim1 <- data_frame(system = c("USM", "UML", "USL", "USML"),
                                          flower.vs.leaf = NA, 
                                          beetle.vs.leaf = NA, 
                                          beetle.vs.flower = NA)
## loop
for (i in 1:length(allvis.aim1_twilight.list)) {
  
   meantable.i <- aggregate(allvis.aim1_twilight.list[[i]][,"dS"], 
                            by = list(allvis.aim1_twilight.list[[i]]$vissys), 
                            mean) 
   mean.i <- meantable.i[, 2] 
   contrast.list_twilight.aim1[,i+1] <- mean.i # here same at column i+1 because the 1st column is the visual system names
}

## print out the table 
contrast.list_twilight.aim1 %>% pander() 
```
### Aim 2 {.tabset .tabset-fade .tabset-pills}
The table shows the mean contrast in each comparison group

#### Daylight
```{r}
allvis.aim2_d65.list <- list(allvis.fl_d65.aim2, allvis.bl_d65.aim2, allvis.bf_d65.aim2)

## create a data frame to hold the loop output
contrast.list_d65.aim2 <- data_frame(system = c("VS 580", "VS 600", "VS 620", "VS 640", "VS 660"),
                                     flower.vs.leaf = NA, 
                                     beetle.vs.leaf = NA, 
                                     beetle.vs.flower = NA)
## loop
for (i in 1:length(allvis.aim2_d65.list)) {
  
   meantable.i <- aggregate(allvis.aim2_d65.list[[i]][,"dS"], 
                            by = list(allvis.aim2_d65.list[[i]]$vissys), 
                            mean) 
   mean.i <- meantable.i[, 2] 
   contrast.list_d65.aim2[,i+1] <- mean.i # here same at column i+1 because the 1st column is the visual system names
}

## print out the table 
contrast.list_d65.aim2 %>% pander() 
```
#### Twilight
```{r}
allvis.aim2_twilight.list <- list(allvis.fl_twilight.aim2, allvis.bl_twilight.aim2, allvis.bf_twilight.aim2)

## create a data frame to hold the loop output
contrast.list_twilight.aim2 <- data_frame(system = c("VS 580", "VS 600", "VS 620", "VS 640", "VS 660"),
                                          flower.vs.leaf = NA,
                                          beetle.vs.leaf = NA, 
                                          beetle.vs.flower = NA)
## loop
for (i in 1:length(allvis.aim2_twilight.list)) {
  
   meantable.i <- aggregate(allvis.aim2_twilight.list[[i]][,"dS"], 
                            by = list(allvis.aim2_twilight.list[[i]]$vissys), 
                            mean) 
   mean.i <- meantable.i[, 2] 
   contrast.list_twilight.aim2[,i+1] <- mean.i # here same at column i+1 because the 1st column is the visual system names
}

## print out the table 
contrast.list_twilight.aim2 %>% pander() 
```

</br>
</br>

# Compare contrasts

* To compare contrasts between visual systems, We conducted Wald chi-square tests on generalised linear mixed models (GLMM) followed by posthoc tests.

* In the models, we assigned
    + Independent variable: __contrast__
    + Dependent variable: 
        + Fixed factor: __visual system__
        + Random factor: __sample ID__ of both targets in the comparison

```{r Create different comparison groups for furthur GLMM analysis} 
# Organize data before GLMM

## D65 - aim 1
### flower vs leaf
vislist.fl_d65.aim1 <- list("contrast.UVSWMW...flower.vs.leaf",
                            "contrast.UV..MWLW.flower.vs.leaf", 
                            "contrast.UVSW..LW.flower.vs.leaf",
                            "contrast.UVSWMWLW.flower.vs.leaf")
compare.flower.vs.leaf.aim1 <- data_frame()
for (i in 1:length(aim1.vissys_d65)) {

temp.i <-  aim1.vissys_d65[[i]] %>% 
  filter(str_detect(patch1, "flower")) %>% 
  filter(str_detect(patch2, "leaves")) %>% 
  dplyr::select(1:3)

temp.i$peak_wl.flower.vs.leaf <- strrep(vislist.fl_d65.aim1[[i]],1)

compare.flower.vs.leaf.aim1 <- compare.flower.vs.leaf.aim1 %>% rbind(temp.i)
}

### beetle vs leaf
vislist.bl_d65.aim1 <- list("contrast.UVSWMW...beetle.vs.leaf",
                            "contrast.UV..MWLW.beetle.vs.leaf", 
                            "contrast.UVSW..LW.beetle.vs.leaf",
                            "contrast.UVSWMWLW.beetle.vs.leaf")
compare.beetle.vs.leaf.aim1 <- data_frame()
for (i in 1:length(aim1.vissys_d65)) {

temp.i <-  aim1.vissys_d65[[i]] %>% 
  filter(str_detect(patch1, "leaves")) %>% 
  filter(str_detect(patch2, "beetle")) %>% 
  dplyr::select(1:3)

temp.i$peak_wl.beetle.vs.leaf <- strrep(vislist.bl_d65.aim1[[i]],1)

compare.beetle.vs.leaf.aim1 <- compare.beetle.vs.leaf.aim1 %>% rbind(temp.i)
}

### beetle vs flower
vislist.bf_d65.aim1 <- list("contrast.UVSWMW...beetle.vs.flower",
                            "contrast.UV..MWLW.beetle.vs.flower", 
                            "contrast.UVSW..LW.beetle.vs.flower",
                            "contrast.UVSWMWLW.beetle.vs.flower")
compare.beetle.vs.flower.aim1 <- data_frame()
for (i in 1:length(aim1.vissys_d65)) {

temp.i <-  aim1.vissys_d65[[i]] %>% 
  filter(str_detect(patch1, "flower")) %>% 
  filter(str_detect(patch2, "beetle")) %>% 
  dplyr::select(1:3)

temp.i$peak_wl.beetle.vs.flower <- strrep(vislist.bf_d65.aim1[[i]],1)

compare.beetle.vs.flower.aim1 <- compare.beetle.vs.flower.aim1 %>% rbind(temp.i)
}


## D65 - Aim 2
### flower vs leaf
vislist.fl_d65.aim2 <- list("bup580.flower.vs.leaf",
                            "bup600.flower.vs.leaf", 
                            "bup620.flower.vs.leaf",
                            "bup640.flower.vs.leaf",
                            "bup660.flower.vs.leaf")
compare.flower.vs.leaf.aim2 <- data_frame()
for (i in 1:length(aim2.vissys_d65)) {

temp.i <-  aim2.vissys_d65[[i]] %>% 
  filter(str_detect(patch1, "flower")) %>% 
  filter(str_detect(patch2, "leaves")) %>% 
  dplyr::select(1:3)

temp.i$peak_wl.flower.vs.leaf <- strrep(vislist.fl_d65.aim2[[i]],1)

compare.flower.vs.leaf.aim2 <- compare.flower.vs.leaf.aim2 %>% rbind(temp.i)
}

### beetle vs leaf
vislist.bl_d65.aim2 <- list("bup580.beetle.vs.leaf",
                            "bup600.beetle.vs.leaf", 
                            "bup620.beetle.vs.leaf",
                            "bup640.beetle.vs.leaf",
                            "bup660.beetle.vs.leaf")
compare.beetle.vs.leaf.aim2 <- data_frame()
for (i in 1:length(aim2.vissys_d65)) {

temp.i <-  aim2.vissys_d65[[i]] %>% 
  filter(str_detect(patch1, "leaves")) %>% 
  filter(str_detect(patch2, "beetle")) %>% 
  dplyr::select(1:3)

temp.i$peak_wl.beetle.vs.leaf <- strrep(vislist.bl_d65.aim2[[i]],1)

compare.beetle.vs.leaf.aim2 <- compare.beetle.vs.leaf.aim2 %>% rbind(temp.i)
}


### beetle vs flower
vislist.bf_d65.aim2 <- list("bup580.beetle.vs.flower",
                            "bup600.beetle.vs.flower", 
                            "bup620.beetle.vs.flower",
                            "bup640.beetle.vs.flower",
                            "bup660.beetle.vs.flower")
compare.beetle.vs.flower.aim2 <- data_frame()
for (i in 1:length(aim2.vissys_d65)) {

temp.i <-  aim2.vissys_d65[[i]] %>% 
  filter(str_detect(patch1, "flower")) %>% 
  filter(str_detect(patch2, "beetle")) %>% 
  dplyr::select(1:3)

temp.i$peak_wl.beetle.vs.flower <- strrep(vislist.bf_d65.aim2[[i]],1)

compare.beetle.vs.flower.aim2 <- compare.beetle.vs.flower.aim2 %>% rbind(temp.i)
}


## Twilight - aim 1
### flower vs leaf
vislist.fl_twilight.aim1 <- list("contrast.UVSWMW...flower.vs.leaf_twilight",
                                 "contrast.UV..MWLW.flower.vs.leaf_twilight", 
                                 "contrast.UVSW..LW.flower.vs.leaf_twilight",
                                 "contrast.UVSWMWLW.flower.vs.leaf_twilight")
compare.flower.vs.leaf_twilight.aim1 <- data_frame()
for (i in 1:length(aim1.vissys_twilight)) {

temp.i <-  aim1.vissys_twilight[[i]] %>% 
  filter(str_detect(patch1, "flower")) %>% 
  filter(str_detect(patch2, "leaves")) %>% 
  dplyr::select(1:3)

temp.i$peak_wl.flower.vs.leaf <- strrep(vislist.fl_twilight.aim1[[i]],1)

compare.flower.vs.leaf_twilight.aim1 <- compare.flower.vs.leaf_twilight.aim1 %>% rbind(temp.i)
}

### beetle vs leaf
vislist.bl_twilight.aim1 <- list("contrast.UVSWMW...beetle.vs.leaf_twilight",
                                 "contrast.UV..MWLW.beetle.vs.leaf_twilight", 
                                 "contrast.UVSW..LW.beetle.vs.leaf_twilight",
                                 "contrast.UVSWMWLW.beetle.vs.leaf_twilight")
compare.beetle.vs.leaf_twilight.aim1 <- data_frame()
for (i in 1:length(aim1.vissys_twilight)) {

temp.i <-  aim1.vissys_twilight[[i]] %>% 
  filter(str_detect(patch1, "leaves")) %>% 
  filter(str_detect(patch2, "beetle")) %>% 
  dplyr::select(1:3)

temp.i$peak_wl.beetle.vs.leaf <- strrep(vislist.bl_twilight.aim1[[i]],1)

compare.beetle.vs.leaf_twilight.aim1 <- compare.beetle.vs.leaf_twilight.aim1 %>% rbind(temp.i)
}

### beetle vs flower
vislist.bf_twilight.aim1 <- list("contrast.UVSWMW...beetle.vs.flower_twilight",
                                 "contrast.UV..MWLW.beetle.vs.flower_twilight", 
                                 "contrast.UVSW..LW.beetle.vs.flower_twilight",
                                 "contrast.UVSWMWLW.beetle.vs.flower_twilight")
compare.beetle.vs.flower_twilight.aim1 <- data_frame()
for (i in 1:length(aim1.vissys_twilight)) {

temp.i <-  aim1.vissys_twilight[[i]] %>% 
  filter(str_detect(patch1, "flower")) %>% 
  filter(str_detect(patch2, "beetle")) %>% 
  dplyr::select(1:3)

temp.i$peak_wl.beetle.vs.flower <- strrep(vislist.bf_twilight.aim1[[i]],1)

compare.beetle.vs.flower_twilight.aim1 <- compare.beetle.vs.flower_twilight.aim1 %>% rbind(temp.i)
}


## Twilight - Aim 2
### flower vs leaf
vislist.fl_twilight.aim2 <- list("bup580.flower.vs.leaf_twilight",
                            "bup600.flower.vs.leaf_twilight", 
                            "bup620.flower.vs.leaf_twilight",
                            "bup640.flower.vs.leaf_twilight",
                            "bup660.flower.vs.leaf_twilight")
compare.flower.vs.leaf_twilight.aim2 <- data_frame()
for (i in 1:length(aim2.vissys_twilight)) {

temp.i <-  aim2.vissys_twilight[[i]] %>% 
  filter(str_detect(patch1, "flower")) %>% 
  filter(str_detect(patch2, "leaves")) %>% 
  dplyr::select(1:3)

temp.i$peak_wl.flower.vs.leaf <- strrep(vislist.fl_twilight.aim2[[i]],1)

compare.flower.vs.leaf_twilight.aim2 <- compare.flower.vs.leaf_twilight.aim2 %>% rbind(temp.i)
}

### beetle vs leaf
vislist.bl_twilight.aim2 <- list("bup580.beetle.vs.leaf_twilight",
                            "bup600.beetle.vs.leaf_twilight", 
                            "bup620.beetle.vs.leaf_twilight",
                            "bup640.beetle.vs.leaf_twilight",
                            "bup660.beetle.vs.leaf_twilight")
compare.beetle.vs.leaf_twilight.aim2 <- data_frame()
for (i in 1:length(aim2.vissys_twilight)) {

temp.i <-  aim2.vissys_twilight[[i]] %>% 
  filter(str_detect(patch1, "leaves")) %>% 
  filter(str_detect(patch2, "beetle")) %>% 
  dplyr::select(1:3)

temp.i$peak_wl.beetle.vs.leaf <- strrep(vislist.bl_twilight.aim2[[i]],1)

compare.beetle.vs.leaf_twilight.aim2 <- compare.beetle.vs.leaf_twilight.aim2 %>% rbind(temp.i)
}

### beetle vs flower
vislist.bf_twilight.aim2 <- list("bup580.beetle.vs.flower_twilight",
                            "bup600.beetle.vs.flower_twilight", 
                            "bup620.beetle.vs.flower_twilight",
                            "bup640.beetle.vs.flower_twilight",
                            "bup660.beetle.vs.flower_twilight")
compare.beetle.vs.flower_twilight.aim2 <- data_frame()
for (i in 1:length(aim2.vissys_twilight)) {

temp.i <-  aim2.vissys_twilight[[i]] %>% 
  filter(str_detect(patch1, "flower")) %>% 
  filter(str_detect(patch2, "beetle")) %>% 
  dplyr::select(1:3)

temp.i$peak_wl.beetle.vs.flower <- strrep(vislist.bf_twilight.aim2[[i]],1)

compare.beetle.vs.flower_twilight.aim2 <- compare.beetle.vs.flower_twilight.aim2 %>% rbind(temp.i)
}
```

## Check assumptions {.tabset .tabset-fade .tabset-pills}

* Before running the GLMMs, we first check if the data follows the assumption of normality and homogeneity of variance

</br>

Click the tabs to choose the assumptions ( __Normality__ / __Homogeneity__ ) of the visual models ( __Aim 1__ / __Aim 2__ ) under different light conditions ( __Daylight__ / __Twilight__)

</br>
```{r Group data for regressions}
# list data for the following loops
input.list.regres_d65.aim1 <- list(compare.flower.vs.leaf.aim1,
                                compare.beetle.vs.leaf.aim1,
                                compare.beetle.vs.flower.aim1)
input.list.regres_twilight.aim1 <- list(compare.flower.vs.leaf_twilight.aim1,
                                     compare.beetle.vs.leaf_twilight.aim1,
                                     compare.beetle.vs.flower_twilight.aim1)
input.list.regres_d65.aim2 <- list(compare.flower.vs.leaf.aim2,
                                compare.beetle.vs.leaf.aim2,
                                compare.beetle.vs.flower.aim2)
input.list.regres_twilight.aim2 <- list(compare.flower.vs.leaf_twilight.aim2,
                                     compare.beetle.vs.leaf_twilight.aim2,
                                     compare.beetle.vs.flower_twilight.aim2)
```

```{r Create regressions for assumption check}
##D65 - aim 1
res.list_d65.aim1 <- list(NA)

for (i in 1:length(input.list.regres_d65.aim1)) {
  res.i <- lm(
    input.list.regres_d65.aim1[[i]]$dS ~ input.list.regres_d65.aim1[[i]][,4])
  res.list_d65.aim1[[i]] <- res.i
}


##D65 - Aim 2
res.list_d65.aim2 <- list(NA)

for (i in 1:length(input.list.regres_d65.aim2)) {
  res.i <- lm(
    input.list.regres_d65.aim2[[i]]$dS ~ input.list.regres_d65.aim2[[i]][,4])
  res.list_d65.aim2[[i]] <- res.i
}

##Twilight - aim 1
res.list_twilight.aim1 <- list(NA)

for (i in 1:length(input.list.regres_twilight.aim1)) {
  res.i <- lm(
    input.list.regres_twilight.aim1[[i]]$dS ~ input.list.regres_twilight.aim1[[i]][,4])
  res.list_twilight.aim1[[i]] <- res.i
}

##Twilight - Aim 2
res.list_twilight.aim2 <- list(NA)

for (i in 1:length(input.list.regres_twilight.aim2)) {
  res.i <- lm(
    input.list.regres_twilight.aim2[[i]]$dS ~ input.list.regres_twilight.aim2[[i]][,4])
  res.list_twilight.aim2[[i]] <- res.i
}
```

### Normality {.tabset .tabset-fade .tabset-pills}

```{r Group data for the normality test}
group.list <- list("Flower vs Leaf", "Beetle vs Leaf", "Beetle vs Flower")
input.list.norm_d65.aim1 <- list(res.list_d65.aim1[[1]], 
                                 res.list_d65.aim1[[2]],
                                 res.list_d65.aim1[[3]])
input.list.norm_twilight.aim1 <- list(res.list_twilight.aim1[[1]], 
                                      res.list_twilight.aim1[[2]],
                                      res.list_twilight.aim1[[3]])
input.list.norm_d65.aim2 <- list(res.list_d65.aim2[[1]], 
                                 res.list_d65.aim2[[2]],
                                 res.list_d65.aim2[[3]])
input.list.norm_twilight.aim2 <- list(res.list_twilight.aim2[[1]], 
                                      res.list_twilight.aim2[[2]],
                                      res.list_twilight.aim2[[3]])
```
#### Aim 1 {.tabset .tabset-fade .tabset-pills}

##### D65 
```{r}
par(mfrow = c(1,3), pin = c(1.5, 1.5))
for (i in 1:length(input.list.norm_d65.aim1)) {
  
  qqnorm(input.list.norm_d65.aim1[[i]]$residuals, 
         main = group.list[[i]])
}
```

##### Twilight
```{r}
par(mfrow=c(1,3), pin = c(1.5, 1.5))
for (i in 1:length(input.list.norm_twilight.aim1)) {
  
  qqnorm(input.list.norm_twilight.aim1[[i]]$residuals, 
         main = group.list[[i]])
}
```

#### Aim 2 {.tabset .tabset-fade .tabset-pills}
##### D65 
```{r}
par(mfrow=c(1,3), pin = c(1.5, 1.5))
for (i in 1:length(input.list.norm_d65.aim2)) {
  
  qqnorm(input.list.norm_d65.aim2[[i]]$residuals, 
         main = group.list[[i]])
}
```

##### Twilight
```{r}
par(mfrow=c(1,3), pin = c(1.5, 1.5))
for (i in 1:length(input.list.norm_twilight.aim2)) {
  
  qqnorm(input.list.norm_twilight.aim2[[i]]$residuals, 
         main = group.list[[i]])
}
```

### Homoscedasticity {.tabset .tabset-fade .tabset-pills}
```{r}
vislist.aim1 <- c("UML", "USL", "USM", "USML")
vislist.aim2 <- c("VS 580", "VS 600", "VS 620", "VS 640", "VS 660")
```

#### Aim 1 {.tabset .tabset-fade .tabset-pills}

##### D65
```{r}
par (mfrow = c(1,3), oma = c(2,2,0,0)) #oma=c() to create space for common labels

for (i in 1:length(input.list.regres_d65.aim1)) {
boxplot(input.list.regres_d65.aim1[[i]]$dS ~ input.list.regres_d65.aim1[[i]][,4], 
        # the forth column is the compairson group name
        las = 2,
        main = group.list[[i]],
        names = vislist.aim1)
}

mtext("Visual system",side = 1, line = 0, outer = TRUE, cex = 1.3) 
#side assigns the position of the text e.g. bottom
mtext("Contrast (JND)",side = 2, line = 0, outer = TRUE, cex = 1.3, las = 0) 
#las assigns the orientation of the text
```

##### Twilight
```{r}
par (mfrow = c(1,3), oma = c(2,2,0,0))

for (i in 1:length(input.list.regres_twilight.aim1)) {
boxplot(input.list.regres_twilight.aim1[[i]]$dS ~ input.list.regres_twilight.aim1[[i]][,4], 
        las = 2,
        main = group.list[[i]],
        names = vislist.aim1)
}

mtext("Visual system",side = 1, line = 0, outer = TRUE, cex = 1.3) 
mtext("Contrast (JND)",side = 2, line = 0, outer = TRUE, cex = 1.3, las = 0) 
```

#### Aim 2 {.tabset .tabset-fade .tabset-pills}
##### D65
```{r}
par (mfrow = c(1,3), oma = c(2,2,0,0))

for (i in 1:length(input.list.regres_d65.aim2)) {
boxplot(input.list.regres_d65.aim2[[i]]$dS ~ input.list.regres_d65.aim2[[i]][,4], 
        las = 2,
        main = group.list[[i]],
        names = vislist.aim2)
}

mtext("Visual system",side = 1, line = 0, outer = TRUE, cex = 1.3) 
mtext("Contrast (JND)",side = 2, line = 0, outer = TRUE, cex = 1.3, las = 0) 
```

##### Twilight 
```{r}
par (mfrow = c(1,3), oma = c(2,2,0,0))

for (i in 1:length(input.list.regres_twilight.aim2)) {
boxplot(input.list.regres_twilight.aim2[[i]]$dS ~ input.list.regres_twilight.aim2[[i]][,4], 
        las = 2,
        main = group.list[[i]],
        names = vislist.aim2)
}

mtext("Visual system",side = 1, line = 0, outer = TRUE, cex = 1.3) 
mtext("Contrast (JND)",side = 2, line = 0, outer = TRUE, cex = 1.3, las = 0) 
```


</br>
</br>

## GLMM results

</br>

```{r Run GLMM models}
#GLMM - D65 - aim 1
##Flower vs Leaf
m.flower.vs.leaf_d65.aim1 <- lmer(dS ~ peak_wl.flower.vs.leaf + (1|patch2) + (1|patch1), 
                                  data = input.list.regres_d65.aim1[[1]], REML = F)
sum.flower.vs.leaf_d65.aim1 <- summary(glht(m.flower.vs.leaf_d65.aim1, 
                                            linfct = mcp(peak_wl.flower.vs.leaf = "Tukey")),
                                       test = adjusted("bonferroni"))
#REML=F, in order to fit the model using the likelihood ratio test. Otherwise, the lmer default will fit the model using the REML (REstricted Maximum Likelihood) criterion.

##Beetle vs Leaf
m.beetle.vs.leaf_d65.aim1 <- lmer(dS ~ peak_wl.beetle.vs.leaf + (1|patch2) + (1|patch1), 
                                  data = input.list.regres_d65.aim1[[2]], REML = F)
sum.beetle.vs.leaf_d65.aim1 <- summary(glht(m.beetle.vs.leaf_d65.aim1, 
                                            linfct = mcp(peak_wl.beetle.vs.leaf = "Tukey")), 
                                       test = adjusted("bonferroni"))
##Beetle vs Flower
m.beetle.vs.flower_d65.aim1 <- lmer(dS ~ peak_wl.beetle.vs.flower + (1|patch2) + (1|patch1), 
                                    data = input.list.regres_d65.aim1[[3]], REML = F)
sum.beetle.vs.flower_d65.aim1 <-summary(glht(m.beetle.vs.flower_d65.aim1, 
                                             linfct = mcp(peak_wl.beetle.vs.flower = "Tukey")), 
                                        test = adjusted("bonferroni"))

#GLMM - D65 - Aim 2
##Flower vs Leaf
m.flower.vs.leaf_d65.aim2 <- lmer(dS ~ peak_wl.flower.vs.leaf + (1|patch2) + (1|patch1), 
                                  data = input.list.regres_d65.aim2[[1]], REML = F)
sum.flower.vs.leaf_d65.aim2 <- summary(glht(m.flower.vs.leaf_d65.aim2, 
                                            linfct = mcp(peak_wl.flower.vs.leaf = "Tukey")), 
                                       test = adjusted("bonferroni"))

##Beetle vs Leaf
m.beetle.vs.leaf_d65.aim2 <- lmer(dS ~ peak_wl.beetle.vs.leaf + (1|patch2) + (1|patch1), 
                                  data = input.list.regres_d65.aim2[[2]], REML = F)
sum.beetle.vs.leaf_d65.aim2 <- summary(glht(m.beetle.vs.leaf_d65.aim2, 
                                            linfct = mcp(peak_wl.beetle.vs.leaf = "Tukey")), 
                                       test = adjusted("bonferroni"))

##Beetle vs Flower
m.beetle.vs.flower_d65.aim2 <- lmer(dS ~ peak_wl.beetle.vs.flower + (1|patch2) + (1|patch1), 
                                    data = input.list.regres_d65.aim2[[3]], REML = F)
sum.beetle.vs.flower_d65.aim2 <- summary(glht(m.beetle.vs.flower_d65.aim2, 
                                              linfct = mcp(peak_wl.beetle.vs.flower = "Tukey")), 
                                         test = adjusted("bonferroni"))


#GLMM - Twilight - Aim 1
##Flower vs Leaf
m.flower.vs.leaf_twilight.aim1 <- lmer(dS ~ peak_wl.flower.vs.leaf + (1|patch2) + (1|patch1), 
                                       data = input.list.regres_twilight.aim1[[1]], REML = F)
sum.flower.vs.leaf_twilight.aim1 <- summary(glht(m.flower.vs.leaf_twilight.aim1, 
                                                 linfct = mcp(peak_wl.flower.vs.leaf = "Tukey")), 
                                            test = adjusted("bonferroni"))
##Beetle vs Leaf
m.beetle.vs.leaf_twilight.aim1 <- lmer(dS ~ peak_wl.beetle.vs.leaf + (1|patch2) + (1|patch1), 
                                       data = input.list.regres_twilight.aim1[[2]], REML = F)
sum.beetle.vs.leaf_twilight.aim1 <- summary(glht(m.beetle.vs.leaf_twilight.aim1, 
                                               linfct = mcp(peak_wl.beetle.vs.leaf = "Tukey")), 
                                            test = adjusted("bonferroni"))

##Beetle vs Flower
m.beetle.vs.flower_twilight.aim1 <- lmer(dS ~ peak_wl.beetle.vs.flower + (1|patch2) + (1|patch1), 
                                         data = input.list.regres_twilight.aim1[[3]], REML = F)
sum.beetle.vs.flower_twilight.aim1<-summary(glht(m.beetle.vs.flower_twilight.aim1, 
                                                 linfct = mcp(peak_wl.beetle.vs.flower = "Tukey")), 
                                            test = adjusted("bonferroni"))

#GLMM - Twilight - Aim 2
##Flower vs Leaf
m.flower.vs.leaf_twilight.aim2 <- lmer(dS ~ peak_wl.flower.vs.leaf + (1|patch2) + (1|patch1), 
                                       data = input.list.regres_twilight.aim2[[1]], REML = F)
sum.flower.vs.leaf_twilight.aim2 <- summary(glht(m.flower.vs.leaf_twilight.aim2, 
                                                 linfct = mcp(peak_wl.flower.vs.leaf = "Tukey")), 
                                            test = adjusted("bonferroni"))

##Beetle vs Leaf
m.beetle.vs.leaf_twilight.aim2 <- lmer(dS ~ peak_wl.beetle.vs.leaf + (1|patch2) + (1|patch1), 
                                       data = input.list.regres_twilight.aim2[[2]], REML = F)
sum.beetle.vs.leaf_twilight.aim2 <- summary(glht(m.beetle.vs.leaf_twilight.aim2, 
                                                 linfct = mcp(peak_wl.beetle.vs.leaf = "Tukey")), 
                                            test = adjusted("bonferroni"))

##Beetle vs Flower
m.beetle.vs.flower_twilight.aim2 <- lmer(dS ~ peak_wl.beetle.vs.flower + (1|patch2) + (1|patch1), 
                                         data = input.list.regres_twilight.aim2[[3]], REML = F)
sum.beetle.vs.flower_twilight.aim2 <- summary(glht(m.beetle.vs.flower_twilight.aim2, 
                                                  linfct = mcp(peak_wl.beetle.vs.flower = "Tukey")), 
                                              test = adjusted("bonferroni"))
```

```{r Set up lists and function for heap maps}
# Set up lists
vislist.heatmap.aim1 <- list(c("USL", "USM","USML","USM","USML","USML"),
                             c("UML", "UML","UML","USL","USL","USM"))
vislist.heatmap.aim2 <- list(c("VS 600", "VS 620","VS 640","VS 660","VS 620","VS 640","VS 660","VS 640","VS 660","VS 660"),
                             c("VS 580","VS 580","VS 580","VS 580","VS 600","VS 600","VS 600","VS 620","VS 620","VS 640"))

# Set up the function
get.heatmap.datframe <- function(i,z){
  
  heatmapdat.i <- data.frame(names(i[[1]]),
                            as.numeric(str_extract(i[[1]],"([0-9]+).*$"))) %>%
  cbind(as.numeric(str_extract(i[[2]],"([0-9]+).*$"))) %>% 
  cbind(as.numeric(str_extract(i[[3]],"([0-9]+).*$"))) %>%
  dplyr::rename(orignial.list = 1, flower.vs.leaf = 2, beetle.vs.leaf = 3, beetle.vs.flower = 4) %>% 
  cbind(z[[1]]) %>% 
  cbind(z[[2]]) %>% 
  dplyr::select(-orignial.list) 
  colnames(heatmapdat.i)[4:5] <- c("VislistA", "VislistB")
  
  return(heatmapdat.i)
}
```

```{r Create p-value heat map}
# D65 - Aim 1
## reshape data for heat map
pdata_d65.aim1 <- list(sum.flower.vs.leaf_d65.aim1[["test"]][["pvalues"]],
                       sum.beetle.vs.leaf_d65.aim1[["test"]][["pvalues"]],
                       sum.beetle.vs.flower_d65.aim1[["test"]][["pvalues"]])

heat_d65.aim1 <- get.heatmap.datframe(pdata_d65.aim1, vislist.heatmap.aim1)


# D65 - Aim 2
## reshape data for heat map
pdata_d65.aim2 <- list(sum.flower.vs.leaf_d65.aim2[["test"]][["pvalues"]],
                       sum.beetle.vs.leaf_d65.aim2[["test"]][["pvalues"]],
                       sum.beetle.vs.flower_d65.aim2[["test"]][["pvalues"]])

heat_d65.aim2 <- get.heatmap.datframe(pdata_d65.aim2, vislist.heatmap.aim2)

#Twilight - Aim 1
## reshape data for heatmap
pdata_twilight.aim1 <- list(sum.flower.vs.leaf_twilight.aim1[["test"]][["pvalues"]],
                            sum.beetle.vs.leaf_twilight.aim1[["test"]][["pvalues"]],
                            sum.beetle.vs.flower_twilight.aim1[["test"]][["pvalues"]])

heat_twilight.aim1 <- get.heatmap.datframe(pdata_twilight.aim1, vislist.heatmap.aim1)


# Twilight - Aim 2
##reshape data for heat map
pdata_twilight.aim2 <- list(sum.flower.vs.leaf_twilight.aim2[["test"]][["pvalues"]],
                       sum.beetle.vs.leaf_twilight.aim2[["test"]][["pvalues"]],
                       sum.beetle.vs.flower_twilight.aim2[["test"]][["pvalues"]])

heat_twilight.aim2 <- get.heatmap.datframe(pdata_twilight.aim2, vislist.heatmap.aim2)


# Assign asterisk signs
pdatalist <- list(heat_d65.aim1, heat_d65.aim2, heat_twilight.aim1, heat_twilight.aim2)

for (i in 1:length(pdatalist)) {
  
  pdatalist[[i]]$sig.flower.vs.leaf[pdatalist[[i]]$flower.vs.leaf > 0.05] <- ""
  pdatalist[[i]]$sig.flower.vs.leaf[pdatalist[[i]]$flower.vs.leaf < 0.05] <- "*"
  pdatalist[[i]]$sig.flower.vs.leaf[pdatalist[[i]]$flower.vs.leaf < 0.01] <- "**"
  pdatalist[[i]]$sig.flower.vs.leaf[pdatalist[[i]]$flower.vs.leaf < 0.0001] <- "***"
  pdatalist[[i]]$sig.beetle.vs.leaf[pdatalist[[i]]$beetle.vs.leaf > 0.05] <- ""
  pdatalist[[i]]$sig.beetle.vs.leaf[pdatalist[[i]]$beetle.vs.leaf < 0.05] <- "*"
  pdatalist[[i]]$sig.beetle.vs.leaf[pdatalist[[i]]$beetle.vs.leaf < 0.01] <- "**"
  pdatalist[[i]]$sig.beetle.vs.leaf[pdatalist[[i]]$beetle.vs.leaf < 0.0001] <- "***"
  pdatalist[[i]]$sig.beetle.vs.flower[pdatalist[[i]]$beetle.vs.flower > 0.05] <- ""
  pdatalist[[i]]$sig.beetle.vs.flower[pdatalist[[i]]$beetle.vs.flower < 0.05] <- "*"
  pdatalist[[i]]$sig.beetle.vs.flower[pdatalist[[i]]$beetle.vs.flower < 0.01] <- "**"
  pdatalist[[i]]$sig.beetle.vs.flower[pdatalist[[i]]$beetle.vs.flower < 0.0001] <- "***"
  
}

# Because we did the assignment on a data list, now we need to link the loop output back to the data respectively
heat_d65.aim1 <- pdatalist[[1]] 
heat_d65.aim2 <- pdatalist[[2]]
heat_twilight.aim1 <- pdatalist[[3]]
heat_twilight.aim2 <- pdatalist[[4]]
```

### Results of Aim 1: comparing visual systems with different photoreceptor combinations {.tabset .tabset-fade .tabset-pills}

</br>

Click the tabs to see the results for each comparison group ( __Flower vs. Leaf__ / __Beetle vs. Leaf__ / __Beetle vs. Flower__) and under different light conditions ( __Daylight__ / __Twilight__)
```{r Function for p-value heat maps}
# a = data
# b = 1/2/3; 1 for flower.vs.leaf, 2 for beetle.vs.leaf, 3 for beetle.vs.flower
get.pheatmap <- function(a, b){ggplot(data = a, 
                                        aes(x = VislistA, 
                                            y = VislistB, 
                                            fill = a[,b])) + 
    geom_tile(colour = "white", size = 4)+
    geom_text(aes(VislistA, 
                  VislistB, 
                  label = paste(format(round(a[,b], 2), nsmall = 2), 
                                a[, b+5])))+
    scale_fill_continuous(high = "#132B43", low = "#56B1F7", limit = c(0,1))+ #delete if want to reverse the colour
    theme_bw()+
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid = element_blank(), 
          panel.border = element_blank(), 
          axis.ticks = element_blank() )+
    labs(fill = "p vaalue")
  
}
```

</br>

#### __Flower v.s Leaf__ {.tabset .tabset-fade .tabset-pills}
##### Daylight{.tabset .tabset-fade .tabset-pills}

```{r}
Anova(m.flower.vs.leaf_d65.aim1) %>% pander()
```

</br>
</br>

Click the tabs to see posthoc results ( __p-value summary plot__ / __original model output__ )

###### Pair-wise p-values 
```{r}
get.pheatmap(heat_d65.aim1, 1)
```

###### Original model output
```{r}
sum.flower.vs.leaf_d65.aim1
```

##### Twilight{.tabset .tabset-fade .tabset-pills}
```{r}
Anova(m.flower.vs.leaf_twilight.aim1) %>% pander()
```

</br>
</br>

Click the tabs to see posthoc results ( __p-value summary plot__ / __original model output__ )

###### Pair-wise p-values
```{r}
get.pheatmap(heat_twilight.aim1, 1)
```

###### Original model output
```{r}
sum.flower.vs.leaf_twilight.aim1
```

#### __Beetle vs. Leaf__ {.tabset .tabset-fade .tabset-pills}
##### Daylight{.tabset .tabset-fade .tabset-pills}
```{r}
Anova(m.beetle.vs.leaf_d65.aim1) %>% pander()
```

</br>
</br>

Click the tabs to see posthoc results ( __p-value summary plot__ / __original model output__ )

###### Pair-wise p-values 
```{r}
get.pheatmap(heat_d65.aim1, 2)
```

###### Original model output
```{r}
sum.beetle.vs.leaf_d65.aim1
```

##### Twilight{.tabset .tabset-fade .tabset-pills}
```{r}
Anova(m.beetle.vs.leaf_twilight.aim1) %>% pander()
```

</br>
</br>

Click the tabs to see posthoc results ( __p-value summary plot__ / __original model output__ )

###### Pair-wise p-values
```{r}
get.pheatmap(heat_twilight.aim1, 2)
```

###### Original model output
```{r}
sum.beetle.vs.leaf_twilight.aim1
```

#### __Beetle vs. Flower__ {.tabset .tabset-fade .tabset-pills}
##### Daylight{.tabset .tabset-fade .tabset-pills}
```{r}
Anova(m.beetle.vs.flower_d65.aim1) %>% pander()
```

</br>
</br>

Click the tabs to see posthoc results ( __p-value summary plot__ / __original model output__ )

###### Pair-wise p-values 
```{r}
get.pheatmap(heat_d65.aim1, 3)
```

###### Original model output
```{r}
sum.beetle.vs.flower_d65.aim1
```

##### Twilight{.tabset .tabset-fade .tabset-pills}
```{r}
Anova(m.beetle.vs.flower_twilight.aim1) %>% pander()
```

</br>
</br>

Click the tabs to see posthoc results ( __p-value summary plot__ / __original model output__ )

###### Pair-wise p-values
```{r}
get.pheatmap(heat_twilight.aim1, 3)
```

###### Original model output
```{r}
sum.beetle.vs.flower_twilight.aim1
```


</br>
</br>


### Results of Aim 2: comparing visual systems with different LWS peak sensitivities {.tabset .tabset-fade .tabset-pills}

</br>

Click the tabs to see the results for each comparison group ( __Flower vs. Leaf__ / __Beetle vs. Leaf__ / __Beetle vs. Flower__) and under different light conditions ( __Daylight__ / __Twilight__)

</br>

#### __Flower v.s Leaf__ {.tabset .tabset-fade .tabset-pills}
##### Daylight {.tabset .tabset-fade .tabset-pills}

```{r}
Anova(m.flower.vs.leaf_d65.aim2) %>% pander()
```

</br>
</br>

Click the tabs to see posthoc results ( __p-value summary plot__ / __original model output__ )

###### Pair-wise p-values 
```{r}
get.pheatmap(heat_d65.aim2, 1)
```

###### Original model output
```{r}
sum.flower.vs.leaf_d65.aim2
```

##### Twilight {.tabset .tabset-fade .tabset-pills}
```{r}
Anova(m.flower.vs.leaf_twilight.aim2) %>% pander()
```

</br>
</br>

Click the tabs to see posthoc results ( __p-value summary plot__ / __original model output__ )

###### Pair-wise p-values
```{r}
get.pheatmap(heat_twilight.aim2, 1)
```

###### Original model output
```{r}
sum.flower.vs.leaf_twilight.aim2
```

#### __Beetle vs. Leaf__ {.tabset .tabset-fade .tabset-pills}
##### Daylight{.tabset .tabset-fade .tabset-pills}
```{r}
Anova(m.beetle.vs.leaf_d65.aim2) %>% pander()
```

</br>
</br>

Click the tabs to see posthoc results ( __p-value summary plot__ / __original model output__ )

###### Pair-wise p-values 
```{r}
get.pheatmap(heat_d65.aim2, 2)
```

###### Original model output
```{r}
sum.beetle.vs.leaf_d65.aim2
```

##### Twilight{.tabset .tabset-fade .tabset-pills}
```{r}
Anova(m.beetle.vs.leaf_twilight.aim2) %>% pander()
```

</br>
</br>

Click the tabs to see posthoc results ( __p-value summary plot__ / __original model output__ )

###### Pair-wise p-values
```{r}
get.pheatmap(heat_twilight.aim2, 2)
```

###### Original model output
```{r}
sum.beetle.vs.leaf_twilight.aim2
```

#### __Beetle vs. Flower__ {.tabset .tabset-fade .tabset-pills}
##### Daylight{.tabset .tabset-fade .tabset-pills}
```{r}
Anova(m.beetle.vs.flower_d65.aim2) %>% pander()
```

</br>
</br>

Click the tabs to see posthoc results ( __p-value summary plot__ / __original model output__ )

###### Pair-wise p-values 
```{r}
get.pheatmap(heat_d65.aim2, 3)
```

###### Original model output
```{r}
sum.beetle.vs.flower_d65.aim2
```

##### Twilight{.tabset .tabset-fade .tabset-pills}
```{r}
Anova(m.beetle.vs.flower_twilight.aim2) %>% pander()
```

</br>
</br>

Click the tabs to see posthoc results ( __p-value summary plot__ / __original model output__ )

###### Pair-wise p-values
```{r}
get.pheatmap(heat_twilight.aim2, 3)
```

###### Original model output
```{r}
sum.beetle.vs.flower_twilight.aim2
```


</br>
</br>

# Plot the contrasts {.tabset .tabset-fade .tabset-pills}
* Colours approximate human perception of either flower (left and right) or beetle (centre) colouration.
* Lines of the same colors connect the same sample
```{r Import color code and setup functions}
#import the sample color code 
color.code <- read.csv("data/color code list.csv", header=TRUE) 

# Set up a function to calculate means for the plot
get.plotmeans <- function(a, b, c){
  if (a == "aim1"){
    if(b == "bl"){
      plotmean.i <- c %>% 
        group_by(patch2, vissys) %>%
        summarize(mean.dS.sub = mean(dS)) %>% 
        ungroup() %>% 
        rename(beetleID = patch2) %>% 
        merge(beetle.colour.aim1[,c("species", "colour")], by.x = c("beetleID"), by.y = c("species")) %>% 
        distinct()
      return(plotmean.i)
    } else {
      plotmean.i <- c %>% 
        group_by(patch1, vissys) %>%
        summarize(mean.dS.sub = mean(dS)) %>% 
        ungroup() %>% 
        rename(flowerID = patch1) %>% 
        merge(flower.colour.aim1[,c("species", "colour")], by.x = c("flowerID"), by.y = c("species")) %>% 
        distinct()
      return(plotmean.i)
    }
  } else if (a == "aim2"){
    if (b == "bl"){
      plotmean.i <- c %>% 
        group_by(patch2, vissys) %>%
        summarize(mean.dS.sub = mean(dS)) %>% 
        ungroup() %>% 
        rename(beetleID = patch2) %>% 
        merge(beetle.colour.aim2[,c("species", "colour")], by.x = c("beetleID"), by.y = c("species")) %>% 
        distinct()
      return(plotmean.i)
    } else {
      plotmean.i <- c %>% 
        group_by(patch1, vissys) %>%
        summarize(mean.dS.sub = mean(dS)) %>% 
        ungroup() %>% 
        rename(flowerID = patch1) %>% 
        merge(flower.colour.aim2[,c("species", "colour")], by.x = c("flowerID"), by.y = c("species")) %>% 
        distinct()
      return(plotmean.i)
    }
  }
}

# What should be put in the function get.plotmeans()
# a = "aim1" or "aim2"
# b = comparison type: "fl", "bl", "bf"
# c = input data, e.g. allvis.fl_d65.aim1
```

```{r Create colour code lists for the plot}
#create a list of species name used in the spec data in oder to merge() with mean data set later
name.list <- unique(dataset.transpose$species) %>% 
  sort() %>% #order it alphabetically 
  data.frame() %>% 
  dplyr::rename(species = ".") #make it a data frame and name the column "species"

# create flower and beetle name list 
colourgrouplist <- c( "flower", "beetle")
tempcolordat <- vector("list", 4)

## for aim 1
for(i in seq_along(colourgrouplist)){
  
  ouput.i <- name.list %>% 
    filter(str_detect(species, colourgrouplist[i])) %>% 
    cbind(color.code %>% 
            filter(str_detect(type, colourgrouplist[i])) %>% 
            arrange(name)) %>% 
    dplyr::select(-type) %>% 
    mutate(count = 4) %>% 
    uncount(count) 
  
  tempcolordat[[i]] <- ouput.i
  
}
flower.colour.aim1 <- tempcolordat[[1]]
beetle.colour.aim1 <- tempcolordat[[2]]

## for Aim 2
for(i in seq_along(colourgrouplist)){
  
  ouput.i <- name.list %>% 
    filter(str_detect(species, colourgrouplist[i])) %>% 
    cbind(color.code %>% 
            filter(str_detect(type, colourgrouplist[i])) %>% 
            arrange(name)) %>% 
    dplyr::select(-type) %>% 
    mutate(count = 5) %>% 
    uncount(count) 
  
  tempcolordat[[i+2]] <- ouput.i # here same in i+2 because 1-2 is for aim1
  
}
flower.colour.aim2 <- tempcolordat[[3]]
beetle.colour.aim2 <- tempcolordat[[4]]
```

```{r Calculate means for each visual system on the plot}
allvis.list <- list(allvis.fl_d65.aim1, allvis.bl_d65.aim1, allvis.bf_d65.aim1,
                 allvis.fl_d65.aim2, allvis.bl_d65.aim2, allvis.bf_d65.aim2,
                 allvis.fl_twilight.aim1, allvis.bl_twilight.aim1, allvis.bf_twilight.aim1,
                 allvis.fl_twilight.aim2, allvis.bl_twilight.aim2, allvis.bf_twilight.aim2)

tempcolordat <- vector("list", length(allvis.list))

for(i in seq_along(allvis.list)){
  
  temp.meandS.i <- allvis.list[[i]] %>% 
    group_by(vissys) %>%
    summarize(mean.dS = mean(dS))
  
  tempcolordat[[i]] <- temp.meandS.i
  
}
```

```{r Set up list and functions for plots}
title.list <- list("Flower vs. Leaf", "Beetle vs. Leaf", "Beetle vs. Flower")
ylim.list <- c(21, 2) # 21 for aim1, 2 for aim2
vislable.list <- list(c("USM", "UML", "USL","USML"), # aim1
                      c("VS 580", "VS 600","VS 620","VS 640","VS 660")) # aim2

vis.comp.list <- list(fl.aim1 <- c("VS1.fl", "VS2.fl", "VS3.fl", "VS4.fl"),
                      bl.aim1 <- c("VS1.bl", "VS2.bl", "VS3.bl", "VS4.bl"),
                      bf.aim1 <- c("VS1.bf", "VS2.bf", "VS3.bf", "VS4.bf"),
                      fl.aim2 <- c("VS1.fl", "VS2.fl", "VS3.fl", "VS4.fl", "VS5.fl"),
                      bl.aim2 <- c("VS1.bl", "VS2.bl", "VS3.bl", "VS4.bl", "VS5.bl"),
                      bf.aim2 <- c("VS1.bf", "VS2.bf", "VS3.bf", "VS4.bf", "VS5.bf"))

stats.list <- list(fl_d65.aim1 <- c("a","a","b","b"),
                   bl_d65.aim1 <- c("a","b","b","b"),
                   bf_d65.aim1 <- c("a","a","b","b"),
                   fl_d65.aim2 <- c("a","b","c","d","d"),
                   bl_d65.aim2 <- c("a","b","c","d","e"),
                   bf_d65.aim2 <- c("a","b","c","d","e"),
                   fl_twilight.aim1 <- c("a","b","c","d"),
                   bl_twilight.aim1 <- c("a","b","b","c"),
                   bf_twilight.aim1 <- c("a","b","c","d"),
                   fl_twilight.aim2 <- c("a","b","c","d","e"),
                   bl_twilight.aim2 <- c("a","b","c","d","d"),
                   bf_twilight.aim2 <- c("a","b","c","d","d"))

backgorund.list <- c("grey80", NA) # choose NA for beetle.vs.leaf

get.contrastplot <- function(dat, title, vislable, upperylim, visomplist, compgroupnstats, background){
  ggplot(dat, aes(x = vissys, 
                y = mean.dS.sub,
                group = factor(dat[,1])))+
    geom_point(col = dat$colour,
               size = 1, alpha = 0.7) + 
    geom_line(col = dat$colour, 
              size = 0.5, alpha = 0.7)+
    xlab("Visual system") +     
    ylab("Chromatic contrast (JND)") +
    ylim(0, ylim.list[upperylim])+
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.background = element_rect(fill = backgorund.list[background], size = NA), 
          axis.title.x = element_text(size = 12),  
          axis.text.x  = element_text(size = 8, colour = "black", angle = 90),
          axis.title.y = element_text(size = 12, vjust = 1),
          axis.text.y = element_text(size = 8, colour = "black"),
          axis.line.x = element_line(colour = 'black', size = 0.5, linetype = 'solid'),
          axis.line.y = element_line(colour = 'black', size = 0.5, linetype = 'solid'),
          legend.justification = c(1,0), 
          legend.position = c(1,0.45),
          legend.key = element_blank(),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 9))+
    scale_x_discrete(limits = vis.comp.list[[visomplist]],
                     labels = vislable.list[vislable])+
    geom_point(data = dat, 
               aes(x = vis.comp.list[[visomplist]][1], 
                   y = tempcolordat[[compgroupnstats]]$mean.dS[1]),
               col = "black", size = 3)+
    geom_point(data = dat, 
               aes(x = vis.comp.list[[visomplist]][2], 
                   y = tempcolordat[[compgroupnstats]]$mean.dS[2]), 
               col = "black", size = 3)+
    geom_point(data = dat, 
               aes(x = vis.comp.list[[visomplist]][3], 
                   y = tempcolordat[[compgroupnstats]]$mean.dS[3]), 
               col = "black", size = 3)+
    geom_point(data = dat, 
               aes(x = vis.comp.list[[visomplist]][4], 
                   y = tempcolordat[[compgroupnstats]]$mean.dS[4]), 
               col = "black", size = 3)+
    geom_point(data = dat, 
               aes(x = vis.comp.list[[visomplist]][5], 
                   y = tempcolordat[[compgroupnstats]]$mean.dS[5]), 
               col = "black", size = 3)+
    ggtitle(title.list[[title]])+
    annotate("text", x = vis.comp.list[[visomplist]], y = ylim.list[upperylim], 
             label = stats.list[[compgroupnstats]])
    
}

```
</br>

## Aim 1 {.tabset .tabset-fade .tabset-pills}
### Daylight
```{r,fig.cap="Figure caption: Comparison of chromatic contrast for visual systems with different photoreceptor combinations. Black dots show the means of the representative contrasts in visual systems. Each coloured dot represents the average contrast of each flower pattern to all leaves (left panel), each beetle colour to all leaves (middle panel) or each flower colour to all beetle colours (right panel). Colours of the dots correspond to the human-visible colour of the flower (left and right panels) or beetle (middle panel) with the lines of the same colour connecting the results between different visual systems. This is for graphical representation only; statistical tests are based on all pairwise combinations of spectra and not averages. Letters on the top of each panel show the significant difference in contrast between visual systems. Dotted horizontal line indicates JND=1. Three contrasts > 13 JND are from flowers that have high UV - blue chroma compared to beetles and leaves."}

# create a data set for means
mean.fl_d65.aim1 <- get.plotmeans("aim1", "fl", allvis.fl_d65.aim1)
mean.bl_d65.aim1 <- get.plotmeans("aim1", "bl", allvis.bl_d65.aim1)
mean.bf_d65.aim1 <- get.plotmeans("aim1", "bf", allvis.bf_d65.aim1)

# plot individual panel
fl_d65.aim1 <- get.contrastplot(mean.fl_d65.aim1, 1, 1, 1, 1, 1, 1) # flower vs leaf
bl_d65.aim1 <- get.contrastplot(mean.bl_d65.aim1, 2, 1, 1, 2, 2, 2) # beetle vs leaf
bf_d65.aim1 <- get.contrastplot(mean.bf_d65.aim1, 3, 1, 1, 3, 3, 1) # beetle vs flower

# bind the 3 panels
figure_d65.aim1 <- ggarrange(fl_d65.aim1,
                             bl_d65.aim1,
                             bf_d65.aim1, 
                             ncol = 3, nrow = 1)
figure_d65.aim1
```

### Twilight
```{r,fig.cap="Figure caption: Comparison of chromatic contrast for visual systems with different photoreceptor combinations under civil twilight illumination. Black dots show the means of the representative contrasts in visual systems. Each coloured dot represents the average contrast of each flower pattern to all leaves (left panel), each beetle colour to all leaves (middle panel) or each flower colour to all beetle colours (right panel). Colours of the dots correspond to the human-visible colour of the flower (left and right panels) or beetle (middle panel) with the lines of the same colour connecting the results between different visual systems. This is for graphical representation only; statistical tests are based on all pairwise combinations of spectra and not averages. Letters on the top of each panel show the significant difference in contrast between visual systems. Dotted horizontal line indicates JND=1."}
# create a data set for means
mean.fl_twilight.aim1 <- get.plotmeans("aim1", "fl", allvis.fl_twilight.aim1)
mean.bl_twilight.aim1 <- get.plotmeans("aim1", "bl", allvis.bl_twilight.aim1)
mean.bf_twilight.aim1 <- get.plotmeans("aim1", "bf", allvis.bf_twilight.aim1)

# plot individual panel
fl_twilight.aim1 <- get.contrastplot(mean.fl_twilight.aim1, 1, 1, 2, 1, 7, 1)
bl_twilight.aim1 <- get.contrastplot(mean.bl_twilight.aim1, 2, 1, 2, 2, 8, 2)
bf_twilight.aim1 <- get.contrastplot(mean.bf_twilight.aim1, 3, 1, 2, 3, 9, 1)

# bind the 3 panels
figure_twilight.aim1 <- ggarrange(fl_twilight.aim1,
                                  bl_twilight.aim1,
                                  bf_twilight.aim1, 
                                  ncol = 3, nrow = 1)
figure_twilight.aim1
```


## Aim 2 {.tabset .tabset-fade .tabset-pills}
### Daylight
```{r,fig.cap="Figure caption: Comparison of chromatic contrast between visual systems with the LWS photoreceptor peaking at different wavelengths. Black dots show the means of the representative contrasts in visual systems. Each coloured dot represents the average contrast of each flower pattern to all leaves (left panel), each beetle colour to all leaves (middle panel) or each flower colour to all beetle colours (right panel). Colours of the dots correspond to the human-visible colour of the flower (left and right panels) or beetle (middle panel) with the lines of the same colour connecting the results between different visual systems. This is for graphical representation only; statistical tests are based on all pairwise combinations of spectra and not averages. Letters on the top of each panel show the significant difference in contrast between visual systems. Dotted horizontal line indicates JND=1. Three contrasts > 13 JND are from flowers that have high UV - blue chroma compared to beetles and leaves."}

# create a data set for means
mean.fl_d65.aim2 <- get.plotmeans("aim2", "fl", allvis.fl_d65.aim2)
mean.bl_d65.aim2 <- get.plotmeans("aim2", "bl", allvis.bl_d65.aim2)
mean.bf_d65.aim2 <- get.plotmeans("aim2", "bf", allvis.bf_d65.aim2)

# plot individual panel
fl_d65.aim2 <- get.contrastplot(mean.fl_d65.aim2, 1, 2, 1, 4, 4, 1)
bl_d65.aim2 <- get.contrastplot(mean.bl_d65.aim2, 2, 2, 1, 5, 5, 2)
bf_d65.aim2 <- get.contrastplot(mean.bf_d65.aim2, 3, 2, 1, 6, 6, 1)

# bind the 3 panels
figure_d65.aim2 <- ggarrange(fl_d65.aim2,
                             bl_d65.aim2,
                             bf_d65.aim2, 
                             ncol = 3, nrow = 1)
figure_d65.aim2
```

### Twilight
```{r,fig.cap="Figure caption: Comparison of chromatic contrast between visual systems with the LWS photoreceptor peaking at different wavelengths under civil twilight illumination. Black dots show the means of the representative contrasts in visual systems. Each coloured dot represents the average contrast of each flower pattern to all leaves (left panel), each beetle colour to all leaves (middle panel) or each flower colour to all beetle colours (right panel). Colours of the dots correspond to the human-visible colour of the flower (left and right panels) or beetle (middle panel) with the lines of the same colour connecting the results between different visual systems. This is for graphical representation only; statistical tests are based on all pairwise combinations of spectra and not averages. Letters on the top of each panel show the significant difference in contrast between visual systems. Dotted horizontal line indicates JND=1."}
# create a data set for means
mean.fl_twilight.aim2 <- get.plotmeans("aim2", "fl", allvis.fl_twilight.aim2)
mean.bl_twilight.aim2 <- get.plotmeans("aim2", "bl", allvis.bl_twilight.aim2)
mean.bf_twilight.aim2 <- get.plotmeans("aim2", "bf", allvis.bf_twilight.aim2)

# plot individual panel
fl_twilight.aim2 <- get.contrastplot(mean.fl_twilight.aim2, 1, 2, 2, 4, 10, 1)
bl_twilight.aim2 <- get.contrastplot(mean.bl_twilight.aim2, 2, 2, 2, 5, 11, 2)
bf_twilight.aim2 <- get.contrastplot(mean.bf_twilight.aim2, 3, 2, 2, 6, 12, 1)

# bind the 3 panels
figure_twilight.aim2 <- ggarrange(fl_twilight.aim2,
                                  bl_twilight.aim2,
                                  bf_twilight.aim2, 
                                  ncol = 3, nrow = 1)
figure_twilight.aim2
```

# Summary

* Visual models using hypothetical insect visual systems indicate that having both SWS and LWS receptors enhances the contrast of beetles with flowers and flowers with leaves, and a LWS receptor enhances the contrast of beetles against leaves.
</br>
</br>
* The optimal peak sensitivity of the LWS photoreceptor depends on what is being viewed. When comparing beetle colours with both leaves and flowers, contrast increases with increasing LWS λmax up to 660 nm; whereas when comparing flowers against leaves, contrast stops increasing beyond 640 nm.
</br>
</br>
* The contrasts of the models using civil twilight were substantially lower (often < 1 JND) than those using daylight. The contrasts in twilight showed different patterns from those using daylight in Aim 1 models, but were qualitatively similar in Aim 2 models.